name: Check and Execute Rollout
permissions:
  contents: write  # Allow write access to the repository contents (including committing)
  
on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes, adjust as needed.
  workflow_dispatch:  # Allows for manual triggering if needed.

jobs:
  check_rollout_schedule:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: execute rollouts
        id: run-rollout
        shell: pwsh
        run: | 
          $serverNameList = @("server1", "server2", "server3") 
          $osType = "Windows" # Example OS type, adjust as needed
          $parentRid = "RID" # Example RID prefix, adjust as needed
          $serverIndex = 0
          $serverNameList | ForEach-Object -Parallel {
          param (
          $serverName,
          $osType,
          $parentRid,
          $serverIndex
          )
          $serverName = $serverName.Trim()
          $serverIndex++
          $rid = $parentRid.ToString() + $serverIndex.ToString().PadLeft(2, "0")
          $fileName = "$($rid).ini"

           try {
                Write-Host "Running ansible using $($rid).ini - install"
                if ($osType -eq "Windows") {
                echo "rid=$($rid), fileName=$($fileName), serverName=$($serverName), serverIndex=$($serverIndex)"
                 if ($LASTEXITCODE -ne 0) {
                  throw "Error installing rollout on server $($serverName)"
                  }
                 }
               } catch {
                $_
            $validationError = "$($_.Exception.Message)"
            echo "validationError=$($validationError)" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
             throw $validationError
           }}-ArgumentList $serverName, $osType, $parentRid, $serverIndex -ThrottleLimit 5 # Adjust ThrottleLimit as needed
                     
